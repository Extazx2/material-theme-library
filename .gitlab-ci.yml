image: node:16.14.0

stages:
  - prepare
  - publish
  - deploy-storybook
  - release

#############
#############
# On each commit, we need to bump the

prepare:
  stage: prepare
  script:
    - git tag -a "${npm_package_version}" -m "Bump to version %s"
    - git push origin --tags
  tags:
    - build-xl

publish:
  stage: publish
  before_script:
    - npm ci --cache .npm --prefer-offline
    - npm run build sb-legendre-lib
  script:
    - npm config set @liksi:registry https://${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/
    - npm config set //${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken ${CI_JOB_TOKEN}
    - npm run publish_lib
  after_script:
    - echo $npm_package_version
  tags:
    - build-xl
  only:
    - tags

pages:
  stage: deploy-storybook
  cache:
    paths:
      - node_modules/
  artifacts:
    paths:
      - public
  script:
    - npm i
    - npm run build-storybook
  tags:
    - build-xl
  only:
    - main
    - develop
  except:
    - tags

release:
  stage: release
  script:
    - echo $npm_package_version
    # bump version then publish lib
  tags:
    - build-xl
  only:
    - main
  when: manual